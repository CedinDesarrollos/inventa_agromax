{% extends "core/base.html" %}
{% block content %}
<style>
  /* ====== ABM Locales (estilos) ====== */
  .abm-header{
    display:flex; align-items:center; justify-content:space-between;
    gap:12px; margin-bottom:12px; flex-wrap:wrap;
  }
  .abm-header h1{
    margin:0; color:#eaf3ee; font-size:1.25rem; letter-spacing:.2px;
  }
  .search-box{
    display:flex; align-items:center; gap:.5rem;
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);
    padding:.4rem .7rem; border-radius:10px;
  }
  .search-box input{
    background:transparent; border:none; outline:none; color:#eaf3ee;
    font-size:.95rem; width:160px;
  }
  .search-box input::placeholder{ color:#9ca3af; }

  .btn-brand{
    background:var(--brand,#16a34a); color:#fff; border:none;
    padding:.6rem .9rem; border-radius:10px; font-weight:700;
    text-decoration:none; display:inline-flex; align-items:center; gap:.5rem;
    transition:transform .1s ease, filter .15s ease;
  }
  .btn-brand:hover{ filter:brightness(1.05); transform:translateY(-1px); }

  .table-wrap{
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015)), var(--bg-750,#141a21);
    border:1px solid var(--divider,rgba(255,255,255,.08)); border-radius:14px; overflow:hidden;
  }
  .agx-table{ width:100%; border-collapse:separate; border-spacing:0; }
  .agx-table thead th{
    text-align:left; font-size:.8rem; text-transform:uppercase; letter-spacing:.08em;
    color:var(--text-500,#8aa09a); background:rgba(255,255,255,.02);
    border-bottom:1px solid var(--divider,rgba(255,255,255,.08));
    padding:.7rem .8rem; cursor:pointer; user-select:none;
  }
  .agx-table thead th.sort-asc::after{ content:" ‚ñ≤"; font-size:.7rem; }
  .agx-table thead th.sort-desc::after{ content:" ‚ñº"; font-size:.7rem; }

  .agx-table tbody td{
    padding:.6rem .8rem; color:var(--text-300,#c9d2d0);
    border-bottom:1px solid rgba(255,255,255,.06); vertical-align:middle; font-size:.95rem;
  }
  .agx-table tbody tr:hover{ background:rgba(255,255,255,.04); }

  .badge-pill{ display:inline-block; padding:.18rem .5rem; border-radius:999px; font-size:.8rem; font-weight:700; }
  .badge-ok{ background:rgba(22,163,74,.18); border:1px solid rgba(22,163,74,.35); color:#eafff1; }
  .badge-no{ background:rgba(239,68,68,.18); border:1px solid rgba(239,68,68,.35); color:#ffecec; }

  .td-actions{ white-space:nowrap; display:flex; gap:.4rem; align-items:center; justify-content:flex-end; }

  /* Edit como link simple (antes) */
.link-edit{
  color: var(--brand, #16a34a);
  font-weight: 700;
  text-decoration: none;
  padding: .2rem .2rem;   /* un poco de √°rea clickeable */
}
.link-edit:hover{ text-decoration: underline; filter: brightness(1.05); }
.link-edit .ico{ margin-right: .35rem; }

/* mantenemos el delete con el estilo ghost */
.btn-ghost{
  background: rgba(255,255,255,.06);
  color:#e7e7e7; border:1px solid rgba(255,255,255,.12);
  padding:.35rem .55rem; border-radius:8px; text-decoration:none;
}
.btn-ghost:hover{ background:rgba(255,255,255,.12); }
  

  @media (max-width:768px){
    .agx-table thead{ display:none; }
    .agx-table, .agx-table tbody, .agx-table tr, .agx-table td{ display:block; width:100%; }
    .agx-table td::before{
      content:attr(data-th); display:block; font-size:.75rem;
      color:var(--text-500,#8aa09a); text-transform:uppercase; letter-spacing:.06em;
    }
  }
</style>

<div class="abm-header">
  {% if has_endpoint('abm_locales.nuevo') %}
  <a class="btn-brand" href="{{ url_for('abm_locales.nuevo') }}">‚ûï Nuevo Local</a>
  {% endif %}
  <div class="search-box">
    üîç <input id="searchInput" type="text" placeholder="Buscar...">
  </div>
</div>

<div class="table-wrap">
  <table class="agx-table" id="localesTable">
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Ciudad</th>
        <th>Lat</th>
        <th>Lon</th>
        <th>Rank</th>
        <th>Venta/d√≠a</th>
        <th>Activo</th>
        <th style="text-align:right">Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for it in items %}
      {% set venta = "{:,.0f}".format(it.venta_por_dia or 0).replace(",", ".") %}
      <tr data-id="{{ it.id }}">
        <td data-th="Nombre" style="font-weight:700; color:#eaf3ee">{{ it.name }}</td>
        <td data-th="Ciudad">{{ it.city or '' }}</td>
        <td data-th="Lat">{{ '%.6f'|format(it.lat) }}</td>
        <td data-th="Lon">{{ '%.6f'|format(it.lon) }}</td>
        <td data-th="Rank">{{ it.rank or '' }}</td>
        <td data-th="Venta/d√≠a">Gs {{ venta }}</td>
        <td data-th="Activo">
          {% if it.active %}
            <span class="badge-pill badge-ok">S√≠</span>
          {% else %}
            <span class="badge-pill badge-no">No</span>
          {% endif %}
        </td>
          <td data-th="Acciones">
            <div class="td-actions" style="justify-content:flex-end;">
              {% if has_endpoint('abm_locales.editar') %}
              <a class="link-edit" href="{{ url_for('abm_locales.editar', id=it.id) }}">
                <span class="ico">‚úèÔ∏è</span>Editar
              </a>
              {% endif %}
              {% if has_endpoint('abm_locales.eliminar') %}
              <form method="post" action="{{ url_for('abm_locales.eliminar', id=it.id) }}" onsubmit="return confirm('¬øEliminar?')">
                <button class="btn-ghost" type="submit">üóëÔ∏è Eliminar</button>
              </form>
              {% endif %}
            </div>
          </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="8" style="text-align:center; padding:1rem; color:var(--text-500,#8aa09a)">
          No hay locales cargados.
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const table = document.getElementById("localesTable");
  const tbody = table.querySelector("tbody");
  const searchInput = document.getElementById("searchInput");

  // --- Filtro ---
  searchInput.addEventListener("input", () => {
    const q = searchInput.value.toLowerCase();
    tbody.querySelectorAll("tr").forEach(row => {
      const text = row.innerText.toLowerCase();
      row.style.display = text.includes(q) ? "" : "none";
    });
  });

  // --- Ordenamiento ---
  table.querySelectorAll("thead th").forEach((th, idx) => {
    if (th.innerText.trim() === "Acciones") return; // no ordenar Acciones
    th.addEventListener("click", () => {
      const current = th.classList.contains("sort-asc") ? "asc" :
                      th.classList.contains("sort-desc") ? "desc" : null;
      table.querySelectorAll("thead th").forEach(t => t.classList.remove("sort-asc", "sort-desc"));
      const newDir = current === "asc" ? "desc" : "asc";
      th.classList.add(newDir === "asc" ? "sort-asc" : "sort-desc");

      const rows = Array.from(tbody.querySelectorAll("tr"));
      rows.sort((a,b) => {
        const A = a.children[idx].innerText.trim().toLowerCase();
        const B = b.children[idx].innerText.trim().toLowerCase();
        const numA = parseFloat(A.replace(/[^\d.-]/g,""));
        const numB = parseFloat(B.replace(/[^\d.-]/g,""));
        const isNum = !isNaN(numA) && !isNaN(numB);
        if (isNum) return newDir === "asc" ? numA - numB : numB - numA;
        return newDir === "asc" ? A.localeCompare(B) : B.localeCompare(A);
      });
      rows.forEach(r => tbody.appendChild(r));
    });
  });
});
</script>
{% endblock %}
